<!DOCTYPE html>
<html>
<head>
  <link href="../styles.css" rel="stylesheet" type="text/css" />
  <meta charset="utf-8">
  <title>dbmon (@erickmerchant/framework)</title>
</head>
<body>
  <main></main>
  <script src="../ENV.js"></script>
  <script src="../lib/memory-stats.js"></script>
  <script src="../lib/monitor.js"></script>

  <script type="module" crossorigin="anonymous">
    /* global document, ENV, Monitoring */

    import framework, {domUpdate, view} from 'https://www.unpkg.com/@erickmerchant/framework/main.mjs'

    const target = document.querySelector('main')

    const update = domUpdate(target)

    const loadSamples = (commit) => {
      commit(() => {
        Monitoring.renderRate.ping()

        const state = ENV.generateData().toArray()

        setTimeout(() => loadSamples(commit), ENV.timeout)

        return state
      })
    }

    const {main, row, queries} = view

    framework({
      state: [],
      update,
      component(state, commit) {
        if (!state.length) {
          loadSamples(commit)
        }

        return main`<main>
          <table class="table table-striped latest-data">
            <tbody>
              ${state.map((db) => row`<tr>
                <td class="dbname">${db.dbname}</td>
                <td class="query-count">
                  <span class=${db.lastSample.countClassName}>
                    ${db.lastSample.nbQueries}
                  </span>
                </td>
                ${db.lastSample.topFiveQueries.map((query) => queries`<td
                  class=${query.elapsedClassName}
                >
                  ${query.formatElapsed}
                  <div class="popover left">
                    <div class="popover-content">
                      ${query.query}
                    </div>
                    <div class="arrow" />
                  </div>
                </td>`)}
              </tr>`)}
            </tbody>
          </table>
        </main>`
      }
    })
  </script>

  <script src="../ga.js"></script>
</body>
</html>
