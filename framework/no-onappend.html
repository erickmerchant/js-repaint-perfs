<!DOCTYPE html>
<html>
<head>
  <link href="../styles.css" rel="stylesheet" type="text/css" />
  <meta charset="utf-8">
  <title>dbmon (@erickmerchant/framework)</title>
</head>
<body>
  <main></main>
  <script src="../ENV.js"></script>
  <script src="../lib/memory-stats.js"></script>
  <script src="../lib/monitor.js"></script>

  <script type="module" crossorigin="anonymous">
    /* global document, ENV, Monitoring */

    import framework, {domUpdate, html} from 'https://www.unpkg.com/@erickmerchant/framework/main.mjs'

    const target = document.querySelector('main')

    const update = domUpdate(target)

    const {main, div, span, table, tbody, td, tr} = html

    framework({
      state: [],
      update,
      component(state, commit) {
        if (!state.length) {
          const loadSamples = () => {
            commit(() => {
              const state = ENV.generateData().toArray()

              Monitoring.renderRate.ping()

              setTimeout(loadSamples, ENV.timeout)

              return state
            })
          }

          loadSamples()
        }

        return main(
          {

          },
          table(
            {class: 'table table-striped latest-data'},
            tbody(
              {},
              ...state.map((db) => tr(
                {},
                td({class: 'dbname'}, db.dbname),
                td(
                  {class: 'query-count'},
                  span(
                    {class: db.lastSample.countClassName},
                    db.lastSample.nbQueries
                  )
                ),
                ...db.lastSample.topFiveQueries.map((query) => td(
                  {class: query.elapsedClassName},
                  query.formatElapsed,
                  div(
                    {class: 'popover left'},
                    div(
                      {class: 'popover-content'},
                      query.query
                    ),
                    div({class: 'arrow'})
                  )
                ))
              ))
            )
          )
        )
      }
    })
  </script>

  <script src="../ga.js"></script>
</body>
</html>
